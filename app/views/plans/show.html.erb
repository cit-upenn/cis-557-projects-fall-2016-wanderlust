<script src="//maps.google.com/maps/api/js?key=AIzaSyBuAI3mBHp2bs8R_ydUGD_Z91SqB-kGkpg"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes <% @plan.forecast = @plan.data %> -->

<tbody>


  <% if @plan.forecast.has_key? "current_observation" %>

  <p>
    <!-- <strong><%= @plan.city %>, <%= @plan.state %></strong> -->
    <strong><%=  @plan.forecast["current_observation"]["display_location"]["full"] %></strong>
  </p>

  <li><%= @plan.forecast["current_observation"]["weather"] %></li>
  <%= image_tag @plan.forecast["current_observation"]["icon_url"] %>
  <% @weather  = Weather.where(["icon = ?", @plan.forecast["current_observation"]["icon"]]).first %>
  <br>
  <br>
  <% if Weather.exists?(:icon => @plan.forecast["current_observation"]["icon"])%>
  <%=  Weather.where(["icon = ?", @plan.forecast["current_observation"]["icon"]]).first.advice %>
  <% end %>

  <% lat  =  @plan.forecast["current_observation"]["display_location"]["latitude"]
    long =  @plan.forecast["current_observation"]["display_location"]["longitude"]
    dining_places = @plan.restaurants(lat, long)
    places_to_visit = @plan.places_to_visit(lat, long)
    food_location = Hash.new()
    place_location = Hash.new()
  %>
  <br>
  <%= @plan.miles.to_f.class %>
  <% if !dining_places.blank? then%>
  <%= dining_places.businesses.class  %>
    <% dining_places.businesses.each do |place| %>
      <%= content_tag(:a, place.name, href: place.url)  %>
      <br>
      <%= image_tag place.image_url %>
      <br>
      <p><%= "Review : " + place.snippet_text %></p>
      <br>
      <%= place.reservation_url %>
      <br>
      <%= place.eat24_url %>
      <br>
      <% if !place.location.coordinate.latitude.blank? and !place.location.coordinate.longitude.blank? then%>
        <% food_location[place.name] = place.location.coordinate.latitude.to_s + "," + place.location.coordinate.longitude.to_s%>
      <% end %>
    <% end %>
    <% dining_places.businesses.each do |place| %>
       <%= food_location[place.name] %>
    <% end %>
  <% end %>
  <br><br>

  <% if !places_to_visit.blank? then %>
  <h3>Places nearby:</h3>
  <%  places_to_visit.each do |place| %>
    <%= content_tag(:a, place.name, href: place.website) %><br>
    <% if !place.photos[0].blank? then%><img src="<%=place.photos[0].fetch_url(800)%>" width="200px" height="200px"> <% end%>
    <br>
    <% if !place.lat.blank? and !place.lng.blank? then%>
      <% place_location[place.name] = place.lat.to_s + "," + place.lng.to_s%>
    <% end %>
    <%= place_location[place.name] %>
    <%= place.formatted_phone_number %><br>
    <%= place.formatted_address %><br>
    <%= place.rating %><br>
    <% place.reviews.each do |review| %>
      <%= review.author_name %>: &nbsp; <%= review.text %><br>
    <% end %>
    <br><br><br>
  <% end%>
  <% else %>
  <h3>No places could be returned. Location entered does not seem valid.</h3>
  <% end %>

  <% else %>
  <li>Invalid Input</li>
  <li>Clothes to wear can not be displayed: Input Error</li>
  <% if dining_places.blank? then%>
    <li>Unable to suggest restaurants</li>
  <% end %>

  <% end %>
  <br>
  <br>
  <br>
  <br>
  <br>
  <%= link_to 'Search Again', new_plan_path %>

<div style='width: 800px;'>
  <div id="sidebar_builder" style='width: 800px; height: 400px;'>
  </div>
</div>
<div id='sidebar_container'>
</div>

<script type='text/javascript'>
function createSidebarLi(json){
  return ("<li><a>" + json.name + "</a></li>");
};

function bindLiToMarker($li, marker){
  $li.on('click', function(){
    handler.getMap().setZoom(14);
    marker.setMap(handler.getMap());
    marker.panTo();
    google.maps.event.trigger(marker.getServiceObject(), 'click');
  })
};

function createSidebar(json_array){
  _.each(json_array, function(json){
    var $li = $( createSidebarLi(json) );
    $li.appendTo('#sidebar_container');
    bindLiToMarker($li, json.marker);
  });
};

<% if @plan.forecast.has_key? "current_observation" %>
var json_array = [
    { lat: <%= @plan.forecast["current_observation"]["display_location"]["latitude"].to_f %>, lng: <%= @plan.forecast["current_observation"]["display_location"]["longitude"].to_f %>, name: <%=  @plan.forecast["current_observation"]["display_location"]["full"].inspect.html_safe %> , infowindow: <%=  @plan.forecast["current_observation"]["display_location"]["full"].inspect.html_safe %> }
  ];
<% end %>
<% if !food_location.blank? then%>
<% food_location.each do |name, loc| %>

json_array.push({ lat: <%=  loc.split(",")[0].to_f %>, lng: <%=  loc.split(",")[1].to_f %>, name: <%=  name.inspect.html_safe %>, infowindow:  <%=  name.inspect.html_safe %>})

<% end %>
<% end %>

<% if !place_location.blank? then%>
<% place_location.each do |name, loc| %>

json_array.push({ lat: <%=  loc.split(",")[0].to_f %>, lng: <%=  loc.split(",")[1].to_f %>, name: <%=  name.inspect.html_safe %>, infowindow:  <%=  name.inspect.html_safe %>})

<% end %>
<% end %>
handler = Gmaps.build('Google');
handler.buildMap({ internal: {id: 'sidebar_builder'}}, function(){

    var markers = handler.addMarkers(json_array);

  _.each(json_array, function(json, index){
    json.marker = markers[index];
  });

  createSidebar(json_array);
  handler.bounds.extendWith(markers);
  handler.fitMapToBounds();
});

</script>
</tbody>
